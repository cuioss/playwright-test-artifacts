= @cuioss/playwright-test-artifacts

== Status

image:https://github.com/cuioss/playwright-test-artifacts/actions/workflows/npm-build.yml/badge.svg[Node.js CI,link=https://github.com/cuioss/playwright-test-artifacts/actions/workflows/npm-build.yml]
image:https://img.shields.io/badge/License-Apache%202.0-blue.svg[License,link=https://www.apache.org/licenses/LICENSE-2.0]
image:https://img.shields.io/npm/v/@cuioss/playwright-test-artifacts[npm,link=https://www.npmjs.com/package/@cuioss/playwright-test-artifacts]

https://sonarcloud.io/summary/new_code?id=cuioss_playwright-test-artifacts[image:https://sonarcloud.io/api/project_badges/measure?project=cuioss_playwright-test-artifacts&metric=alert_status[Quality Gate Status]]
image:https://sonarcloud.io/api/project_badges/measure?project=cuioss_playwright-test-artifacts&metric=ncloc[Lines of Code,link=https://sonarcloud.io/summary/new_code?id=cuioss_playwright-test-artifacts]
image:https://sonarcloud.io/api/project_badges/measure?project=cuioss_playwright-test-artifacts&metric=coverage[Coverage,link=https://sonarcloud.io/summary/new_code?id=cuioss_playwright-test-artifacts]

== What is it?

A standalone npm package providing Playwright test artifact infrastructure.
It captures browser console logs, JavaScript errors, network failures, and full-page screenshots for every test — automatically.
All artifacts are persisted to Playwright's per-test `testInfo.outputDir`, making them immediately available in CI reports and local debugging.

=== Installation

[source,bash]
----
npm install @cuioss/playwright-test-artifacts
----

=== Quick Start

[source,javascript]
----
// tests/fixtures.js
import { test as base } from "@playwright/test";
import { createArtifactFixture } from "@cuioss/playwright-test-artifacts";

export const test = base.extend(createArtifactFixture());
export { expect } from "@playwright/test";
----

[source,javascript]
----
// tests/example.spec.js
import { test, expect } from "./fixtures.js";

test("homepage loads", async ({ page }) => {
    await page.goto("https://example.com");
    await expect(page).toHaveTitle(/Example/);
});
// -> Artifacts automatically saved: start-test.png (if using takeStartScreenshot),
//    browser.log, test-run.log, end-tests.png
----

== API

[cols="1,1,3"]
|===
| Export | Type | Description

| `TestLogger`
| Class
| Unified logger capturing browser and Node-side logs per test.

| `testLogger`
| Instance
| Singleton `TestLogger` instance for convenient reuse.

| `takeStartScreenshot`
| `async function(page, testInfo)`
| Takes a full-page screenshot named `start-test.png` at the start of a test.

| `createArtifactFixture`
| `function(options?)`
| Factory returning a Playwright fixture definition for `test.extend()`.
|===

=== Per-Test Artifact Contract

Each test using the artifact fixture produces these files in `testInfo.outputDir`:

[cols="1,3"]
|===
| File | Description

| `start-test.png`
| Full-page screenshot taken at test start (requires explicit `takeStartScreenshot` call or `beforeUse` hook).

| `browser.log`
| Browser console messages, JavaScript exceptions, and HTTP errors (status >= 400).

| `test-run.log`
| Node-side log entries from custom `logger.info()` / `logger.warn()` / `logger.error()` calls.

| `end-tests.png`
| Full-page screenshot taken automatically during teardown.
|===

=== Advanced Usage

==== Custom logger instance

[source,javascript]
----
import { test as base } from "@playwright/test";
import { TestLogger, createArtifactFixture } from "@cuioss/playwright-test-artifacts";

const myLogger = new TestLogger();
export const test = base.extend(createArtifactFixture({ logger: myLogger }));
----

==== beforeUse / afterUse hooks

[source,javascript]
----
export const test = base.extend(
    createArtifactFixture({
        async beforeUse(page, testInfo) {
            // Runs after logger setup, before test body — e.g. take start screenshot
            const { takeStartScreenshot } = await import(
                "@cuioss/playwright-test-artifacts"
            );
            await takeStartScreenshot(page, testInfo);
        },
        async afterUse(page, testInfo) {
            // Runs after logs are written — e.g. custom cleanup
            console.log(`Artifacts saved to ${testInfo.outputDir}`);
        },
    }),
);
----

==== Manual TestLogger usage

[source,javascript]
----
import { testLogger } from "@cuioss/playwright-test-artifacts";

// Inside a Playwright test or helper
testLogger.info("MyHelper", "Navigating to login page");
testLogger.warn("MyHelper", "Unexpected redirect detected");
testLogger.error("MyHelper", "Login failed with status 401");
----
